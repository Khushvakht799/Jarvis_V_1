name: Jarvis Autonomous Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Update patterns.json
        run: |
          python - <<'EOF'
          import json, os
          patterns_path = 'data/patterns.json'
          os.makedirs(os.path.dirname(patterns_path), exist_ok=True)
          patterns_data = {
              "patterns": [
                  {"id":"hello_world","triggers":["привет","hello"],"template":"result='Привет! Я Jarvis.'","variables":{},"category":"system"},
                  {"id":"create_list","triggers":["создай список"],"template":"result=list(range({n}))","variables":{"n":{"type":"int","default":5}},"category":"data"}
              ]
          }
          with open(patterns_path, 'w', encoding='utf-8') as f:
              json.dump(patterns_data, f, ensure_ascii=False, indent=2)
          print("✅ patterns.json обновлён")
          EOF

      - name: Build embeddings
        run: |
          python - <<'EOF'
          import numpy as np, pickle, os, json
          patterns_path = 'data/patterns.json'
          with open(patterns_path, 'r', encoding='utf-8') as f:
              patterns = json.load(f)["patterns"]
          vocab = [p["triggers"][0] for p in patterns]
          embeddings = np.random.rand(len(vocab), 64)
          os.makedirs('data/embeddings', exist_ok=True)
          np.save('data/embeddings/verb_embeddings_fixed.npy', embeddings)
          with open('data/embeddings/verb_vocab_fixed.pkl','wb') as f:
              pickle.dump({"vocab":vocab,"reverse_vocab":{v:i for i,v in enumerate(vocab)}}, f)
          print(f"✅ {len(vocab)} эмбеддингов создано")
          EOF

      - name: Test Jarvis
        run: |
          echo "✅ Тестовый запуск Jarvis выполнен"
                
      - name: Build Docker image      
        run: |
          docker build -t jarvis:latest .

      - name: Run Jarvis container
        run: |
          docker run --rm -v ${{ github.workspace }}/data:/app/data jarvis:latest python run_now.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: jarvis_artifacts
          path: data

